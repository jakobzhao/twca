<!doctype html>
<html lang="en">

<head>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
	<meta name="description" content="Geovisual Analytic Platform for TWCA">
	<meta name="author" content="Bo Zhao, Benji Antolin">
	<title>Water Calculator</title>
	<!-- <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css"> -->
	<link rel="stylesheet" href="https://unpkg.com/leaflet@1.0.3/dist/leaflet.css" />
	<link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.8.1/css/all.css">
	<link href="https://fonts.googleapis.com/css?family=Titillium+Web" rel="stylesheet">
	<link href="https://fonts.googleapis.com/css?family=Oswald&display=swap" rel="stylesheet">
	<link href="https://cdnjs.cloudflare.com/ajax/libs/c3/0.6.14/c3.min.css" rel="stylesheet">
	<link rel="stylesheet" href="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.css" />

	<link rel="stylesheet" href="css/main.css">
	<link rel="icon" href="img/favicon.ico" type="image/x-icon" />
	<link rel="shortcut icon" href="img/favicon.ico" type="image/x-icon" />

	<script src="https://unpkg.com/d3@5/dist/d3.js"></script>
	<script src="https://d3js.org/topojson.v1.min.js"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/c3/0.6.14/c3.min.js"></script>

	<script src="https://unpkg.com/leaflet@1.0.3/dist/leaflet.js"></script>
	<script src="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.js"></script>
	<script src="js/L.TopoJSON.js"></script>

	<script src="js/geotiff.js"></script>
	<script src="js/plotty.js"></script>

	<script src="js/leaflet-geotiff.js"></script>

	<script src="https://cdnjs.cloudflare.com/ajax/libs/chroma-js/1.3.4/chroma.min.js"></script>
	<script src="https://code.jquery.com/jquery-3.3.1.min.js"></script>
	<script src="js/simple-statistics.min.js"></script>
	<!-- <script src="js/pako.min.js"></script>
	<script src="js/UPNG.js"></script> -->
</head>

<body>
	<main>
		<div class="loader"></div>
		<div id="info" class="d-flex align-items-start flex-column">
			<h4><i class="fas fa-tachometer-alt"></i> Water Calculator</h4>
			<div id="waterGauge" style="min-height: 150px"></div>

			Wind speed at clicked point is <span id="windSpeedValue">?</span></p>
			 Wind direection at clicked point is <span id="windDirectionValue">?</span></p>
		</div>
		<div id="map" role="main" class="container-fluid"></div>
	</main>
	<script>
		$(window).ready(function() {
			$('.loader').fadeOut("slow");
		});

		var mymap = L.map('map', {
			zoomControl: false,
			center: [42.29981, -101.93603],
			zoom: 5,
			maxZoom: 16,
			minZoom: 1
		});





		function soilStyle(feature) {
			var c = "red";
			switch (+feature.properties.class) {
				case 0:
					c = "yellow";
					break;
				case 1:
					c = "blue";
					break;
				case 2:
					c = "green";
					break;
				default:
					c = "red";
			}
			return {
				fillColor: c,
				fillOpacity: 0.4,
				color: "grey",
				weight: 0.1,
				opacity: 0,
				smoothFactor: 0
			};
		};



		function onEachFeature(feature, layer) {
			var popupContent = "<strong>Class: </strong>" + feature.properties.class;
			if (feature.properties && feature.properties.popupContent) {
				popupContent += feature.properties.popupContent;
			}
			layer.bindPopup(popupContent);
		}


		$(".leaflet-control-attribution")
			.css("background-color", "transparent")
			.html("Supported by <a href='http://geoviz.ceoas.oregonstate.edu' target='_blank'> GeoViz Lab @ Oregon State University </a>");


		var gray = L.tileLayer('http://{s}.basemaps.cartocdn.com/light_nolabels/{z}/{x}/{y}@2x.png');
		var streets = L.tileLayer('http://{s}.basemaps.cartocdn.com/rastertiles/voyager_nolabels/{z}/{x}/{y}@2x.png').addTo(mymap);
		var satellite = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}');

		var baseLayers = {
			'Grayscale': gray,
			'Streets': streets,
			'Satellite': satellite
		}

		var soil, guage, hardness;
		Promise.all([
			d3.json("assets/soil.json")
		]).then(function(datasets) {



			var layer = L.leafletGeotiff("assets/hd4-4326.tif",
            options={band: 0,
                displayMin: 5,
                displayMax: 21,
                name: 'Wind speed',
                colorScale: 'rainbow',
                clampLow: false,
                clampHigh: true,
                //vector:true,
                arrowSize: 20
            }
        ).addTo(mymap);


				mymap.on('click', function(e) {
						// if (!marker) {
						// 		marker = L.marker([e.latlng.lat,e.latlng.lng]).addTo(mymap);
						// } else {
						// 		marker.setLatLng([e.latlng.lat,e.latlng.lng]);
						// }
						document.getElementById("windSpeedValue").innerHTML = layer.getValueAtLatLng(e.latlng.lat,e.latlng.lng).toFixed(0);
						// document.getElementById("windDirectionValue").innerHTML = windDirection.getValueAtLatLng(e.latlng.lat,e.latlng.lng).toFixed(0);
				});

			hardness = L.tileLayer('assets/hardness/{z}/{x}/{y}.png', {
				maxZoom: 7,
				tms: false
			}).addTo(mymap);

			soil = new L.TopoJSON(datasets[0], {
				style: soilStyle
			}).addTo(mymap);


			var overlays = {
				"<span>Soil Class</span>": soil,
				"<span>Plant Hardness</span>": hardness,
				"<span>Place Names</span>": L.tileLayer('https://{s}.basemaps.cartocdn.com/light_only_labels/{z}/{x}/{y}{r}@2x.png')
			};

			L.control.layers(baseLayers, overlays, {
				collapsed: false
			}).addTo(mymap);


			chart = c3.generate({
				data: {
					columns: [
						['data', 91.4]
					],
					type: 'gauge',
					onclick: function(d, i) {
						console.log("onclick", d, i);
					},
					onmouseover: function(d, i) {
						console.log("onmouseover", d, i);
					},
					onmouseout: function(d, i) {
						console.log("onmouseout", d, i);
					}
				},
				legend: {
					show: false
				},
				gauge: {
					label: {
						format: function(value, ratio) {
							return value;
						},
						show: true // to turn off the min/max labels.
					},
					min: 0, // 0 is default, //can handle negative min e.g. vacuum / voltage / current flow / rate of change
					max: 100, // 100 is default
					// units: ' %',
					width: 39 // for adjusting arc thickness
				},
				color: {
					pattern: ['#FF0000', '#F97600', '#F6C600', '#60B044'], // the three color levels for the percentage values.
					threshold: {
						//            unit: 'value', // percentage is default
						//            max: 200, // 100 is default
						values: [30, 60, 90, 100]
					}
				},
				size: {
					height: 180
				},
				bindto: "#waterGauge"
			});



			setTimeout(function() {
				chart.load({
					columns: [
						['data', 10]
					]
				});
			}, 1000);



		});


		var geocoder = L.Control.geocoder({
				defaultMarkGeocode: false,
				placeholder: "Search a location...",
				errorMessage: "Nothing was Found..."
			})
			.on('markgeocode', function(e) {
				var bbox = e.geocode.bbox;
				var poly = L.polygon([
					bbox.getSouthEast(),
					bbox.getNorthEast(),
					bbox.getNorthWest(),
					bbox.getSouthWest()
				]).addTo(mymap);
				mymap.fitBounds(poly.getBounds());
			})
			.addTo(mymap);
	</script>
</body>

</html>
