<!doctype html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <meta name="description" content="Geovisual Analytic Platform for TWCA">
  <meta name="author" content="Bo Zhao, Benji Antolin">
  <title>Water Calculator</title>
  <!-- <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css"> -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.2.0/dist/leaflet.css" />
  <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.8.1/css/all.css">
  <link href="https://fonts.googleapis.com/css?family=Titillium+Web" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css?family=Oswald&display=swap" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/c3/0.6.14/c3.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.css" />
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css" />
  <link rel="stylesheet" href="css/main.css">
  <link rel="stylesheet" href="css/sidebar.css">
  <style>
    .fa-info-circle:hover {
      opacity: 0.3;
    }

    .fa-info-circle {
      color: white;
      font-size: 20px;
    }

    .fa-map-marked-alt:hover {
      opacity: 0.3;
    }

    .fa-map-marked-alt {
      color: white;
      font-size: 20px;
    }

    .btn-primary {
      color: #fff;
      background-color: #343a40;
      border-color: #007bff;
    }

    h4 {
      text-align: center;
    }

    .btn {
      display: inline-block;
      font-weight: 400;
      text-align: center;
      white-space: nowrap;
      vertical-align: middle;
      -webkit-user-select: none;
      -moz-user-select: none;
      -ms-user-select: none;
      user-select: none;
      border: 1px solid transparent;
      padding: .375rem .75rem;
      font-size: 1rem;
      line-height: 1.5;
      border-radius: .25rem;
      transition: color .15s ease-in-out, background-color .15s ease-in-out, border-color .15s ease-in-out, box-shadow .15s ease-in-out;
    }

    .btn-group-sm>.btn,
    .btn-sm {
      padding: .25rem .5rem;
      font-size: 11px;
      line-height: 1.5;
      border-radius: .2rem;
    }

    #lush_legend {
      position: absolute;
      line-height: 12px;
      padding: 3px;
      /* text-align: center; */
    }

    #lush_legend i {
      width: 7.5px;
      height: 12px;
      float: left;
    }
  </style>
  <link rel="icon" href="img/favicon.ico" type="image/x-icon" />
  <link rel="shortcut icon" href="img/favicon.ico" type="image/x-icon" />
  <script src="https://code.jquery.com/jquery-3.3.1.min.js"></script>
  <script src="https://unpkg.com/d3@5/dist/d3.js"></script>
  <script src="https://d3js.org/topojson.v1.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/c3/0.6.14/c3.min.js"></script>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.12.9/umd/popper.min.js"></script>
  <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/js/bootstrap.min.js"></script>

  <script src="https://unpkg.com/leaflet@1.2.0/dist/leaflet.js"></script>
  <script src="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.js"></script>
  <script src="https://unpkg.com/@mapbox/leaflet-pip@latest/leaflet-pip.js"></script>
  <script src="js/L.TopoJSON.js"></script>
  <script src="js/geotiff.js"></script>
  <script src="js/plotty.js"></script>
  <script src="js/leaflet-geotiff.js"></script>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet-ajax/2.1.0/leaflet.ajax.min.js"></script>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/chroma-js/1.3.4/chroma.min.js"></script>

</head>

<body>
  <header>
    <div class="navbar navbar-dark bg-dark shadow-sm">
      <div class="container-fluid d-flex justify-content-between">
        <a href="#" class="navbar-brand d-flex align-items-center">
          <strong><i class="fas fa-tachometer-alt"></i> Water Calculator</strong>
        </a>
        <ul>
          <li><a class="nav-link" href="#"><i class="fas fa-map-marked-alt"></i></a></li>
          <li><a class="nav-link" href="#"><i class="fas fa-info-circle"></i></a></li>
        </ul>
      </div>

    </div>

  </header>

  <main>
    <div class="loader"></div>

    <div id="sidebar">
      <br>
      <h4>Select Lush Level</h4>
      <div class="btn-group btn-group-sm">
        <button type="button" class="btn btn-primary">
          <img src="img/twcaLogo.png" class="img-thumbnail" alt="survival">
          <br>Survival</button>
        <button type="button" class="btn btn-primary">
          <img src="img/twcaLogo.png" class="img-thumbnail" alt="adequate">
          <br>Adequate</button>
        <button type="button" class="btn btn-primary">
          <img src="img/twcaLogo.png" class="img-thumbnail" alt="homeowner">
          <br>Homeowner</button>
        <button type="button" class="btn btn-primary">
          <img src="img/twcaLogo.png" class="img-thumbnail" alt="premium">
          <br>Premium</button>
        <button type="button" class="btn btn-primary">
          <img src="img/twcaLogo.png" class="img-thumbnail" alt="professional">
          <br>Professional</button>
      </div>
      <div id="lush_legend"></div>
      <div id="popup" style="display:none"></div>
      <br><br>
      <!-- <div id="info" class="d-flex align-items-start flex-column"> -->
      <!-- <div id="greenGauge" style="min-height: 150px"></div> -->
      <p><b>(Pr) Precip Runtime (minutes): &nbsp;</b> <span id="runtime">
          <input type="number" name="runtime" min="0"><br>
        </span></p>
      <p><b>(R) Run Events/Week: &nbsp;</b> <span id="run">
          <select>
            <option value="0">Select runs/week:</option>
            <option value="1">0 runs</option>
            <option value="2">1 run</option>
            <option value="3">2 runs</option>
            <option value="4">3 runs</option>
            <option value="5">4 runs</option>
            <option value="6">5 runs</option>
          </select></span>
      </p>
      <p><b>(ET) Evapotranspiration:</b> <span id="et"></span></p>
      <p><b>Plant Hardness:</b> <span id="hardnessLevel"></span></p>
      <p><b>(Sf) Soil Class:</b> <span id="soilClass"></span></p>
      <p><b>(Kc) Turf Zone:</b> <span id="tzone"></span></p>
      <p><b>(Cpf) Cultivar plan factor: &nbsp;</b> <span id="spf">
          <select>
            <option value="0">Select:</option>
            <option value="1">Yes</option>
            <option value="2">No</option>
          </select </span> </p> <p><b>(Pe) Rain Volume: &nbsp;</b>
          <span id="rainVolume">
            <select>
              <option value="0">Select month:</option>
              <option value="1">Jan</option>
              <option value="2">Feb</option>
              <option value="3">Mar</option>
              <option value="4">Apr</option>
              <option value="5">May</option>
              <option value="6">Jun</option>
              <option value="7">Jul</option>
              <option value="8">Aug</option>
              <option value="9">Sep</option>
              <option value="10">Oct</option>
              <option value="11">Nov</option>
              <option value="12">Dec</option>
            </select>
          </span>
      </p>
      <p><b>Test Value:</b> <span id="test"></span></p>
      <div id="waterGauge" style="min-height: 150px"></div>
      <!-- </div> -->
    </div>
    <div id="map" role="main" class="container-fluid"></div>
  </main>

  <!-- Modal -->
  <div id="disclaimer" class="modal fade" tabindex="-1" role="dialog" aria-labelledby="exampleModalCenterTitle" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered" role="document">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="exampleModalLongTitle">Disclaimer</h5>
          <button type="button" class="close" data-dismiss="modal" aria-label="Close">
            <span aria-hidden="true">&times;</span>
          </button>
        </div>
        <div class="modal-body">
          bla bla bla bla bla bla bla bla bla bla bla bla bla bla bla bla bla bla
        </div>
        <div class="modal-footer">
          <button id="disclaimer-close" type="button" class="btn btn-primary">close</button>
        </div>
      </div>
    </div>
  </div>
  <script>
    $(window).ready(function() {
      $('.loader').fadeOut("slow");

      if (localStorage.getItem('popState') != 'shown') {
        console.log("show disclaimer");
        $('#disclaimer').modal('show');
        localStorage.setItem('popState', 'shown');
      } else {
        console.log("hide disclaimer");
        $('#disclaimer').modal('hide');
      }

      $('#disclaimer-close').click(function(e) // You are clicking the close button
        {
          $('#disclaimer').fadeOut(); // Now the pop up is hiden.
          $('#disclaimer').modal('hide');
        });
    });

    // 6. Set function for color ramp
    var colors = chroma.scale('YlGn').colors(50);
    for (var j = 0; j < colors.length; j++) {
      $("#lush_legend").append("<i style='background: " + colors[j] + " ; opacity:0.9'></i>");
    }
    // $("#lush_legend").parent().append("&nbsp; &nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp; &nbsp; <span>more</span>");

    var mymap = L.map('map', {
      zoomControl: false,
      center: [39.29981, -102.93603],
      zoom: 5,
      maxZoom: 16,
      minZoom: 1
    });


    $(".leaflet-control-attribution")
      .css("background-color", "transparent")
      .html("Supported by <a href='http://geoviz.ceoas.oregonstate.edu' target='_blank'> GeoViz Lab @ Oregon State University </a>");


    var gray = L.tileLayer('http://{s}.basemaps.cartocdn.com/light_nolabels/{z}/{x}/{y}@2x.png');
    var streets = L.tileLayer('http://{s}.basemaps.cartocdn.com/rastertiles/voyager_nolabels/{z}/{x}/{y}@2x.png').addTo(mymap);
    var satellite = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}');

    var baseLayers = {
      'Grayscale': gray,
      'Streets': streets,
      'Satellite': satellite
    }

    var hardGroup = L.layerGroup();

    var placename, soil, guage, turfZones, marker, s, tz, chart;


    hardnessCont = L.leafletGeotiff(url = "assets/hd4-4326.tif",
      options = {
        band: 0,
        displayMin: 4,
        displayMax: 22,
        name: 'plant hardness',
        colorScale: 'rainbow',
        clampLow: false,
        clampHigh: true,
        // vector:true,
        arrowSize: 20
      }
    ).addTo(hardGroup);

    // var turfZones = L.geoJson.ajax('assets/turfZones.geojson', {
    //   // style: style2,
    //   onEachFeature: function(feature, layer) {
    //     layer.bindTooltip(feature.properties.zone, {
    //       className: 'feature-label',
    //       permanent: false,
    //       direction: 'center'
    //     });
    //   }
    // });

    placename = L.tileLayer('https://{s}.basemaps.cartocdn.com/light_only_labels/{z}/{x}/{y}{r}@2x.png').addTo(mymap);


    Promise.all([
      d3.json("assets/soil.json"),
      d3.json("assets/rainStates.geojson"),
      d3.json("assets/turfZones.geojson"),
    ]).then(function(datasets) {


      function soilStyle(feature) {
        var c = "red";
        switch (+feature.properties.class) {
          case 0:
            c = "yellow";
            break;
          case 1:
            c = "blue";
            break;
          case 2:
            c = "green";
            break;
          default:
            c = "red";
        }
        return {
          fillColor: c,
          fillOpacity: 0.4,
          color: "grey",
          weight: 0.1,
          opacity: 0,
          smoothFactor: 0
        };
      };

      function turfStyle(feature) {
        var c = "red";
        switch (+feature.properties.zoneID) {
          case 0:
            c = "blue";
            break;
          case 1:
            c = "yellow";
            break;
          case 2:
            c = "red";
            break;
          default:
            c = "red";
        }
        return {
          fillColor: c,
          fillOpacity: 0.2,
          color: "grey",
          weight: 0.1,
          opacity: 0,
          smoothFactor: 0
        };
      };


      function onEachFeature(feature, layer) {
        layer.on({
          click: clickFeature
        });
      };

      function clickFeature(e) {

        if (!marker) {
          marker = L.marker([e.latlng.lat, e.latlng.lng]).addTo(mymap);
        } else {
          marker.setLatLng([e.latlng.lat, e.latlng.lng]);
        }

        h = hardnessCont.getValueAtLatLng(e.latlng.lat, e.latlng.lng).toFixed(0);
        h100 = ((h - 4) * 100 / (22 - 4)).toFixed(0);
        $("#hardnessLevel").html(h100);
        chart.load({
          columns: [
            ['data', h100]
          ]
        });

        s = +this.feature.properties.class;
        $("#soilClass").html(s);

        $("#test").html(s * h100);

        tz = +this.feature.properties.zone;
        $("#tzone").html(tz);
      };


      soil = new L.TopoJSON(datasets[0], {
        style: soilStyle,
        onEachFeature: onEachFeature
      }).addTo(mymap);

      rainStates = L.geoJSON(datasets[1], {
        onEachFeature: function(feature, layer) {
          layer.bindTooltip(feature.properties.NAME, {
            className: 'feature-label',
            permanent: false,
            direction: 'center'
          });
        },
        style: {
          opacity: 0.8,
          fillOpacity: 0,
          weight: 2,
          color: "brown",
          dashArray: '6',
        }
      }).addTo(mymap);

      turfZones = new L.geoJSON(datasets[2], {
        style: turfStyle,
        onEachFeature: onEachFeature
      }).addTo(mymap);

      var overlays = {
        "<span><b>Place Names</b></span>": placename,
        "<span><b>Soil Class</b></span>": soil,
        "<span><b>Plant Hardness</b></span>": hardGroup,
        "<span><b>Turf Zones</b></span>": turfZones,
        "<span><b>Precipitation</b></span>": rainStates,
      };

      L.control.layers(baseLayers, overlays, {
        collapsed: false
      }).addTo(mymap);

      soil.bringToFront();
      placename.bringToFront();

      chart = c3.generate({
        data: {
          columns: [
            ['data', 91.4]
          ],
          type: 'gauge',
          // onclick: function(d, i) {
          //   console.log("onclick", d, i);
          // },
          // onmouseover: function(d, i) {
          //   console.log("onmouseover", d, i);
          // },
          // onmouseout: function(d, i) {
          //   console.log("onmouseout", d, i);
          // }
        },
        legend: {
          show: false
        },
        gauge: {
          label: {
            format: function(value, ratio) {
              return value;
            },
            show: true // to turn off the min/max labels.
          },
          min: 0, // 0 is default, //can handle negative min e.g. vacuum / voltage / current flow / rate of change
          max: 100, // 100 is default
          // units: ' %',
          width: 39 // for adjusting arc thickness
        },
        color: {
          pattern: ['#FF0000', '#F97600', '#F6C600', '#60B044'], // the three color levels for the percentage values.
          threshold: {
            //            unit: 'value', // percentage is default
            //            max: 200, // 100 is default
            values: [30, 60, 90, 100]
          }
        },
        size: {
          height: 180
        },
        bindto: "#waterGauge"
      });

    });





    // mymap.on('click', function(e) {
    //
    //
    //   if (!marker) {
    //     marker = L.marker([e.latlng.lat, e.latlng.lng]).addTo(mymap);
    //   } else {
    //     marker.setLatLng([e.latlng.lat, e.latlng.lng]);
    //   }
    //
    //   h = hardness.getValueAtLatLng(e.latlng.lat, e.latlng.lng).toFixed(0);
    //   h100 = (h * 100 / (22 - 4)).toFixed(0);
    //   $("#hardnessLevel").html(h100);
    //   $("#soilClass").html(s);
    //   chart.load({
    //     columns: [
    //       ['data', h100]
    //     ]
    //   });
    //
    //   // s = soil.getValueAtLatLng(e.latlng.lat, e.latlng.lng);
    //   // h100 = (h100 * 100 / (22 - 4)).toFixed(0);
    //   // $("#soilClass").html(s);
    //   // chart.load({
    //   //   columns: [
    //   //     ['data', s]
    //   //   ]
    //   // });
    //
    //
    //
    // });

    var geocoder = L.Control.geocoder({
        defaultMarkGeocode: false,
        placeholder: "Search a location...",
        errorMessage: "Nothing was Found..."
      })
      .on('markgeocode', function(e) {



        // var bbox = e.geocode.bbox;
        // var poly = L.polygon([
        //   bbox.getSouthEast(),
        //   bbox.getNorthEast(),
        //   bbox.getNorthWest(),
        //   bbox.getSouthWest()
        // ]).addTo(mymap);
        // mymap.fitBounds(poly.getBounds());



        lat = e.geocode.center.lat;
        lng = e.geocode.center.lng;

        soil.fireEvent('click', {
          latlng: new L.latLng(lat, lng)
        });


        if (!marker) {
          marker = L.marker([lat, lng]).addTo(mymap);
        } else {
          marker.setLatLng([lat, lng]);
        }


        h = hardnessCont.getValueAtLatLng(lat, lng).toFixed(0);
        h100 = ((h - 4) * 100 / (22 - 4)).toFixed(0);
        $("#hardnessLevel").html(h100);
        chart.load({
          columns: [
            ['data', h100]
          ]
        });

        var results = leafletPip.pointInLayer([lng, lat], soil);
        s = +results[0].feature.properties.class;
        $("#soilClass").html(s);


        $("#test").html(s * h100);

        mymap.setZoom(10);



      })
      .addTo(mymap);
  </script>
</body>

</html>
