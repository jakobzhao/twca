<!doctype html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <meta name="description" content="Geovisual Analytic Platform for TWCA">
  <meta name="author" content="Bo Zhao, Benji Antolin">
  <title>Water Calculator</title>
  <!-- <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css"> -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.2.0/dist/leaflet.css" />
  <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.8.1/css/all.css">
  <link href="https://fonts.googleapis.com/css?family=Titillium+Web" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css?family=Oswald&display=swap" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/c3/0.6.14/c3.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.css" />
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css" />
  <link rel="stylesheet" href="css/main.css">
  <link rel="icon" href="img/favicon.ico" type="image/x-icon" />
  <link rel="shortcut icon" href="img/favicon.ico" type="image/x-icon" />
  <script src="https://code.jquery.com/jquery-3.3.1.min.js"></script>
  <script src="https://unpkg.com/d3@5/dist/d3.js"></script>
  <script src="https://d3js.org/topojson.v1.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/c3/0.6.14/c3.min.js"></script>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.12.9/umd/popper.min.js"></script>
  <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/js/bootstrap.min.js"></script>

  <script src="https://unpkg.com/leaflet@1.2.0/dist/leaflet.js"></script>
  <script src="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.js"></script>
  <script src="https://unpkg.com/@mapbox/leaflet-pip@latest/leaflet-pip.js"></script>
  <script src="js/L.TopoJSON.js"></script>
  <script src="js/geotiff.js"></script>
  <script src="js/plotty.js"></script>
  <script src="js/leaflet-geotiff.js"></script>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet-ajax/2.1.0/leaflet.ajax.min.js"></script>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/chroma-js/1.3.4/chroma.min.js"></script>

</head>

<body>
  <main>
    <div class="loader"></div>
    <div id="popup" style="display:none"></div>
    <div id="info" class="d-flex align-items-start flex-column">
      <h2><i class="fas fa-tachometer-alt"></i> Water Calculator</h2>
      <!-- <div id="greenGauge" style="min-height: 150px"></div> -->
      <div id="waterGauge" style="min-height: 150px"></div>
      <p><b>Plant Hardness:</b> <span id="hardnessLevel"></span></p>
      <p><b>Soil Class:</b> <span id="soilClass"></span></p>
      <p><b>Rain Volume:</b> <span id="rainVolume"></span> 30 inches</p>
      <p><b>Run Events:</b> <span id="run"></span> 3 events</p>
      <p><b>Test Value:</b> <span id="test"></span></p>
    </div>
    <div id="map" role="main" class="container-fluid"></div>
  </main>

  <!-- Modal -->
  <div id="disclaimer" class="modal fade" tabindex="-1" role="dialog" aria-labelledby="exampleModalCenterTitle" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered" role="document">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="exampleModalLongTitle">Disclaimer</h5>
          <button type="button" class="close" data-dismiss="modal" aria-label="Close">
            <span aria-hidden="true">&times;</span>
          </button>
        </div>
        <div class="modal-body">
          bla bla bla bla bla bla bla bla bla bla bla bla bla bla bla bla bla bla
        </div>
        <div class="modal-footer">
          <button id="disclaimer-close" type="button" class="btn btn-primary">close</button>
        </div>
      </div>
    </div>
  </div>
  <script>
    $(window).ready(function() {
      $('.loader').fadeOut("slow");

      if (localStorage.getItem('popState') != 'shown') {
        console.log("show disclaimer");
        $('#disclaimer').modal('show');
        localStorage.setItem('popState', 'shown');
      } else {
        console.log("hide disclaimer");
        $('#disclaimer').modal('hide');
      }

      $('#disclaimer-close').click(function(e) // You are clicking the close button
        {
          $('#disclaimer').fadeOut(); // Now the pop up is hiden.
          $('#disclaimer').modal('hide');
        });
    });


    var mymap = L.map('map', {
      zoomControl: false,
      center: [42.29981, -101.93603],
      zoom: 5,
      maxZoom: 16,
      minZoom: 1
    });


    $(".leaflet-control-attribution")
      .css("background-color", "transparent")
      .html("Supported by <a href='http://geoviz.ceoas.oregonstate.edu' target='_blank'> GeoViz Lab @ Oregon State University </a>");


    var gray = L.tileLayer('http://{s}.basemaps.cartocdn.com/light_nolabels/{z}/{x}/{y}@2x.png');
    var streets = L.tileLayer('http://{s}.basemaps.cartocdn.com/rastertiles/voyager_nolabels/{z}/{x}/{y}@2x.png').addTo(mymap);
    var satellite = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}');

    var baseLayers = {
      'Grayscale': gray,
      'Streets': streets,
      'Satellite': satellite
    }

    var hardGroup = L.layerGroup().addTo(mymap);

    var placename, soil, guage, hardnessCont, hardnessAK, hardnessHI, hardnessPR, marker, s, chart;


    hardnessCont = L.leafletGeotiff(url = "assets/hd4-4326.tif",
      options = {
        band: 0,
        displayMin: 4,
        displayMax: 22,
        name: 'plant hardness',
        colorScale: 'rainbow',
        clampLow: false,
        clampHigh: true,
        // vector:true,
        arrowSize: 20
      }
    ).addTo(hardGroup);

    hardnessAK = L.leafletGeotiff(url = "assets/hd4-4326-ak.tif",
      options = {
        band: 0,
        displayMin: 4,
        displayMax: 22,
        name: 'plant hardness',
        colorScale: 'rainbow',
        clampLow: false,
        clampHigh: true,
        // vector:true,
        arrowSize: 20
      }
    ).addTo(hardGroup);

    hardnessHI = L.leafletGeotiff(url = "assets/hd4-4326-hi.tif",
      options = {
        band: 0,
        displayMin: 4,
        displayMax: 22,
        name: 'plant hardness',
        colorScale: 'rainbow',
        clampLow: false,
        clampHigh: true,
        // vector:true,
        arrowSize: 20
      }
    ).addTo(hardGroup);

    hardnessPR = L.leafletGeotiff(url = "assets/hd4-4326-pr.tif",
      options = {
        band: 0,
        displayMin: 4,
        displayMax: 22,
        name: 'plant hardness',
        colorScale: 'rainbow',
        clampLow: false,
        clampHigh: true,
        // vector:true,
        arrowSize: 20
      }
    ).addTo(hardGroup);

    var turfZones = L.geoJson.ajax('assets/turfZones.geojson', {
      // style: style2,
      onEachFeature: function(feature, layer) {
        layer.bindTooltip(feature.properties.zone, {
          className: 'feature-label',
          permanent: false,
          direction: 'center'
        });
      }
    });

    var rainStates = L.geoJson.ajax('assets/rainStates.geojson', {
      // style: style2,
      onEachFeature: function(feature, layer) {
        layer.bindTooltip(feature.properties.NAME, {
          className: 'feature-label',
          permanent: false,
          direction: 'center'
        });
      }
    });

    placename = L.tileLayer('https://{s}.basemaps.cartocdn.com/light_only_labels/{z}/{x}/{y}{r}@2x.png').addTo(mymap);


    Promise.all([
      d3.json("assets/soil.json")
    ]).then(function(datasets) {


      function soilStyle(feature) {
        var c = "red";
        switch (+feature.properties.class) {
          case 0:
            c = "yellow";
            break;
          case 1:
            c = "blue";
            break;
          case 2:
            c = "green";
            break;
          default:
            c = "red";
        }
        return {
          fillColor: c,
          fillOpacity: 0.4,
          color: "grey",
          weight: 0.1,
          opacity: 0,
          smoothFactor: 0
        };
      };


      function onEachFeature(feature, layer) {
        layer.on({
          click: clickFeature
        });
      };

      function clickFeature(e) {

        if (!marker) {
          marker = L.marker([e.latlng.lat, e.latlng.lng]).addTo(mymap);
        } else {
          marker.setLatLng([e.latlng.lat, e.latlng.lng]);
        }

        h = hardnessCont.getValueAtLatLng(e.latlng.lat, e.latlng.lng).toFixed(0);
        h100 = ((h - 4) * 100 / (22 - 4)).toFixed(0);
        $("#hardnessLevel").html(h100);
        chart.load({
          columns: [
            ['data', h100]
          ]
        });

        s = +this.feature.properties.class;
        $("#soilClass").html(s);

        $("#test").html(s * h100);

      };


      soil = new L.TopoJSON(datasets[0], {
        style: soilStyle,
        onEachFeature: onEachFeature
      }).addTo(mymap);


      var overlays = {
        "<span><b>Place Names</b></span>": placename,
        "<span><b>Soil Class</b></span>": soil,
        "<span><b>Plant Hardness</b></span>": hardGroup,
        "<span><b>Turf Zones</b></span>": turfZones,
        "<span><b>Precipitation</b></span>": rainStates,
      };

      L.control.layers(baseLayers, overlays, {
        collapsed: false
      }).addTo(mymap);

      placename.bringToFront();

      chart = c3.generate({
        data: {
          columns: [
            ['data', 91.4]
          ],
          type: 'gauge',
          // onclick: function(d, i) {
          //   console.log("onclick", d, i);
          // },
          // onmouseover: function(d, i) {
          //   console.log("onmouseover", d, i);
          // },
          // onmouseout: function(d, i) {
          //   console.log("onmouseout", d, i);
          // }
        },
        legend: {
          show: false
        },
        gauge: {
          label: {
            format: function(value, ratio) {
              return value;
            },
            show: true // to turn off the min/max labels.
          },
          min: 0, // 0 is default, //can handle negative min e.g. vacuum / voltage / current flow / rate of change
          max: 100, // 100 is default
          // units: ' %',
          width: 39 // for adjusting arc thickness
        },
        color: {
          pattern: ['#FF0000', '#F97600', '#F6C600', '#60B044'], // the three color levels for the percentage values.
          threshold: {
            //            unit: 'value', // percentage is default
            //            max: 200, // 100 is default
            values: [30, 60, 90, 100]
          }
        },
        size: {
          height: 180
        },
        bindto: "#waterGauge"
      });

    });





    // mymap.on('click', function(e) {
    //
    //
    //   if (!marker) {
    //     marker = L.marker([e.latlng.lat, e.latlng.lng]).addTo(mymap);
    //   } else {
    //     marker.setLatLng([e.latlng.lat, e.latlng.lng]);
    //   }
    //
    //   h = hardness.getValueAtLatLng(e.latlng.lat, e.latlng.lng).toFixed(0);
    //   h100 = (h * 100 / (22 - 4)).toFixed(0);
    //   $("#hardnessLevel").html(h100);
    //   $("#soilClass").html(s);
    //   chart.load({
    //     columns: [
    //       ['data', h100]
    //     ]
    //   });
    //
    //   // s = soil.getValueAtLatLng(e.latlng.lat, e.latlng.lng);
    //   // h100 = (h100 * 100 / (22 - 4)).toFixed(0);
    //   // $("#soilClass").html(s);
    //   // chart.load({
    //   //   columns: [
    //   //     ['data', s]
    //   //   ]
    //   // });
    //
    //
    //
    // });

    var geocoder = L.Control.geocoder({
        defaultMarkGeocode: false,
        placeholder: "Search a location...",
        errorMessage: "Nothing was Found..."
      })
      .on('markgeocode', function(e) {



        // var bbox = e.geocode.bbox;
        // var poly = L.polygon([
        //   bbox.getSouthEast(),
        //   bbox.getNorthEast(),
        //   bbox.getNorthWest(),
        //   bbox.getSouthWest()
        // ]).addTo(mymap);
        // mymap.fitBounds(poly.getBounds());



        lat = e.geocode.center.lat;
        lng = e.geocode.center.lng;

        soil.fireEvent('click', {
          latlng: new L.latLng(lat, lng)
        });


        if (!marker) {
          marker = L.marker([lat, lng]).addTo(mymap);
        } else {
          marker.setLatLng([lat, lng]);
        }


        h = hardnessCont.getValueAtLatLng(lat, lng).toFixed(0);
        h100 = ((h - 4) * 100 / (22 - 4)).toFixed(0);
        $("#hardnessLevel").html(h100);
        chart.load({
          columns: [
            ['data', h100]
          ]
        });

        var results = leafletPip.pointInLayer([lng, lat], soil);
        s = +results[0].feature.properties.class;
        $("#soilClass").html(s);


        $("#test").html(s * h100);

        mymap.setZoom(10);



      })
      .addTo(mymap);
  </script>
</body>

</html>
